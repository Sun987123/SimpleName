<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e2e">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=no">
    <title>Water</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" defer></script>

    <style>
        :root {
            /* Palette */
            --primary: #6366f1;
            --bg: #0f172a;
            --surface: #1e293b;
            --border: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --header-h: 60px;
            --tools-w: 340px;
            --radius-sm: 8px;
        }

        [data-theme="light"] {
            --bg: #f1f5f9; --surface: #ffffff; --border: #e2e8f0; --text: #0f172a; --text-muted: #64748b;
        }

        /* Base Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 14px; }

        /* --- Header --- */
        header {
            height: var(--header-h); background: var(--surface); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; z-index: 50;
        }
        .brand { 
            font-weight: 800; font-size: 1.25rem; display:flex; align-items:center; gap:8px; cursor: pointer; user-select: none;
        }
        .brand:active { opacity: 0.7; }
        .brand span { color: var(--primary); }

        /* --- Button & Inputs --- */
        button { cursor: pointer; border: none; background: none; font-family: inherit; }
        .btn {
            padding: 8px 14px; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.85rem;
            background: var(--surface); border: 1px solid var(--border); color: var(--text);
            display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-icon { width: 32px; height: 32px; padding: 0; display: grid; place-items: center; border-radius: 6px; }

        input[type="text"], select {
            width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 10px; border-radius: var(--radius-sm); font-size: 0.9rem;
        }

        /* --- Sliders --- */
        .range-wrap { position: relative; width: 100%; margin: 10px 0 20px 0; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: var(--border); border-radius: 10px; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; 
            background: var(--primary); border: 2px solid var(--bg); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .range-value {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%) scale(0);
            background: var(--primary); color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 0.75rem; font-weight: bold; opacity: 0; transition: 0.2s; pointer-events: none; white-space: nowrap;
        }
        .range-value.show { opacity: 1; transform: translateX(-50%) scale(1); }

        /* --- Workspace --- */
        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* FIX: Removed Flexbox centering to allow Matrix Math to control absolute centering */
        .canvas-area {
            flex: 1; position: relative; overflow: hidden;
            background-image: radial-gradient(var(--border) 1px, transparent 1px);
            background-size: 24px 24px; cursor: grab;
            display: block; /* Changed from flex */
            min-height: 100px;
        }
        .canvas-area.picking { cursor: none; }
        
        .canvas-container { 
            position: absolute; top: 0; left: 0;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            transform-origin: 0 0; 
            pointer-events: none; /* Let events pass to area for panning */
        }
        canvas { pointer-events: auto; display: block; }

        /* --- Resizer Handle --- */
        .resizer-handle {
            width: 1px; background: var(--border); cursor: col-resize; z-index: 40;
            display: flex; align-items: center; justify-content: center; transition: background 0.2s;
        }
        .resizer-handle:hover, .resizer-handle.dragging { background: var(--primary); width: 4px; }
        
        /* --- Tools Panel --- */
        .tools-panel {
            width: var(--tools-w); background: var(--surface); 
            display: flex; flex-direction: column; overflow-y: auto; z-index: 20;
            flex-shrink: 0; 
        }

        .panel-section { padding: 16px; border-bottom: 1px solid var(--border); }
        .section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; }

        /* Icons & Colors */
        .icon-strip { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
        .icon-btn-opt { aspect-ratio: 1; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); display: grid; place-items: center; cursor: pointer; color: var(--text-muted); }
        .icon-btn-opt.active { background: rgba(99, 102, 241, 0.1); border-color: var(--primary); color: var(--primary); }
        .icon-btn-opt svg { width: 18px; height: 18px; }

        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .color-row { display: flex; gap: 8px; align-items: center; }
        .color-well { flex: 1; height: 36px; border-radius: 6px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .color-well input { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; cursor: pointer; padding: 0; border: none; }

        /* Tabs */
        .tabs { display: flex; background: var(--bg); padding: 4px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 16px; }
        .tab { flex: 1; text-align: center; padding: 6px; font-size: 0.8rem; border-radius: 6px; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .tab.active { background: var(--surface); color: var(--primary); font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- Lens --- */
        .pro-lens {
            position: fixed; width: 140px; height: 140px; border-radius: 50%;
            border: 4px solid var(--primary); box-shadow: 0 0 0 4px rgba(0,0,0,0.1), 0 20px 40px rgba(0,0,0,0.5);
            background: var(--bg); pointer-events: none; z-index: 9999; display: none; overflow: hidden;
            transform: translate(-50%, -50%);
        }
        .pro-lens canvas { width: 100%; height: 100%; image-rendering: pixelated; }
        .lens-overlay { position: absolute; inset: 0; background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzPjxwYXR0ZXJuIGlkPSJncmlkIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiPjxwYXRoIGQ9Ik0gMTQgMCBMIDAgMCAwIDE0IiBmaWxsPSJub25lIiBzdHJva2U9InJnYmEoMjU1LDI1NSwyNTUsMC4yKSIgc3Ryb2tlLXdpZHRoPSIxIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyaWQpIiAvPjwvc3ZnPg=='); }
        .lens-crosshair { position: absolute; top: 50%; left: 50%; width: 14px; height: 14px; transform: translate(-50%, -50%); border: 2px solid #ef4444; }
        .lens-info { position: absolute; bottom: 12px; left: 0; right: 0; text-align: center; background: rgba(0,0,0,0.7); color: white; font-size: 10px; font-family: monospace; }

        /* --- Queue & Misc --- */
        .queue-bar { height: 60px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 16px; gap: 10px; overflow-x: auto; flex-shrink: 0; transition: margin-top 0.3s ease; }
        .queue-bar.hidden { margin-top: -61px; }
        
        .q-thumb { width: 44px; height: 44px; border-radius: 6px; overflow: hidden; opacity: 0.6; transition: 0.2s; flex-shrink: 0; position: relative; border: 2px solid transparent; cursor:pointer;}
        .q-thumb.active { border-color: var(--primary); opacity: 1; transform: scale(1.05); }
        .q-thumb img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .q-thumb.done::after { 
            content:'‚úì'; position:absolute; inset:0; background:rgba(16,185,129,0.7); 
            color:white; display:grid; place-items:center; font-weight:bold; font-size:1.2rem;
        }

        .empty-msg { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); pointer-events: none; }
        .d-none { display: none !important; }
        details { margin-top: 4px; background: var(--bg); border-radius: var(--radius-sm); border: 1px solid var(--border); }
        details summary { padding: 10px; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: space-between; }
        .det-content { padding: 12px; border-top: 1px solid var(--border); }

        @media (max-width: 900px) {
            .workspace { flex-direction: column; }
            .resizer-handle { 
                width: 100%; height: 16px; cursor: row-resize; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
                background: var(--surface); position: relative;
            }
            .resizer-handle::after { content: ''; width: 40px; height: 4px; background: var(--border); border-radius: 2px; }
            .tools-panel { width: 100%; border-left: none; }
            .canvas-area { height: 50vh; flex: none; }
            .tools-panel { flex: 1; overflow-y: auto; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand" onclick="app.toggleQueue()" title="Click to Toggle Queue Bar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
        <span></span>Ai<span style="font-size:0.7rem; color:var(--text-muted); margin-left:5px;">(‚ñº)</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn" onclick="app.toggleTheme()">üåó</button>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">‚úô</button>
        <input type="file" id="fileInput" accept="image/*" multiple hidden>
    </div>
</header>

<nav class="queue-bar" id="queueStrip"></nav>

<main class="workspace" id="workspace">
    <section class="canvas-area" id="gestureArea">
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
        </div>
        
        <div class="empty-msg" id="emptyState">
            <p>Upload Your Image</p>
        </div>
        
        <div class="pro-lens" id="proLens">
            <canvas id="lensCanvas"></canvas>
            <div class="lens-overlay"></div>
            <div class="lens-crosshair"></div>
            <div class="lens-info" id="lensColorCode">#FFFFFF</div>
        </div>
    </section>

    <div class="resizer-handle" id="resizer"></div>

    <aside class="tools-panel" id="toolsPanel">
        <div class="panel-section">
            <div class="section-title">Watermark</div>
            <input type="text" id="badgeText" placeholder="Enter Text Here" style="margin-bottom:12px;">
            <div class="icon-strip">
                <div class="icon-btn-opt" onclick="app.setIcon('none')">√ò</div>
                <div class="icon-btn-opt" onclick="app.setIcon('gemini')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L14.1 8.5C14.6 10 15.8 11.2 17.2 11.6L22 12.8L17.2 14C15.8 14.4 14.6 15.6 14.1 17L12 23.6L9.9 17C9.4 15.6 8.2 14.4 6.8 14L2 12.8L6.8 11.6C8.2 11.2 9.4 10 9.9 8.5L12 2Z"/></svg></div>
                <div class="icon-btn-opt" onclick="app.setIcon('chatgpt')">
<svg viewBox="0 0 24 24" fill="currentColor">
<path d="M12 2a5 5 0 014.58 2.88A5 5 0 0122 9.5a5 5 0 01-2.04 4.06A5 5 0 0119 19a5 5 0 01-4.5 3 5 5 0 01-4.59-2.88A5 5 0 012 14.5a5 5 0 012.04-4.06A5 5 0 015 5a5 5 0 014.5-3 5 5 0 012.5 0z"/>
</svg>
</div>

                <div class="icon-btn-opt" onclick="app.setIcon('copilot')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4C7.6 4 4 7.6 4 12s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z"/></svg></div>
                <div class="icon-btn-opt" onclick="app.setIcon('deepseek')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 15c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5z"/></svg></div>
                <div class="icon-btn-opt" onclick="app.setIcon('apple')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 13.9c-.2 2.5 2.2 3.3 2.3 3.4 0 .1-1.3 4.3-4.1 4.3-1.1 0-2.2-.7-3.5-.7-1.3 0-2.6.7-3.4.7-2.7 0-5.5-4.5-5.5-8.2 0-3.5 2.2-5.6 5.3-5.6 1.2 0 2.5.8 3.2.8.8 0 2.1-.9 3.8-.9 1.4 0 2.9.6 4.1 1.7-3.6 1.6-3 6.3-2.2 4.6zM13.5 4c.6-1.5 2.5-2.2 2.5-2.2-2.1.1-4.2 1.5-4.6 3-.3 1.3 1.2 2.5 2.1 2.3z"/></svg></div>
            </div>
        </div>

        <div class="panel-section">
            <div class="section-title">Style & Colors</div>
            <div class="tabs">
                <div class="tab active" onclick="app.setShape('pill')">Pill</div>
                <div class="tab" onclick="app.setShape('rect')">Rect</div>
                <div class="tab" onclick="app.setShape('text')">Text</div>
            </div>

            <div class="control-grid">
                <div>
                    <label style="font-size:0.75rem; color:var(--text-muted)">BG Color</label>
                    <div class="color-row">
                        <div class="color-well" id="boxPrev"><input type="color" id="boxColor"></div>
                        <button class="btn btn-icon" onclick="app.startPicking('boxC')">üîç</button>
                    </div>
                </div>
                <div>
                    <label style="font-size:0.75rem; color:var(--text-muted)">Text Color</label>
                    <div class="color-row">
                        <div class="color-well" id="textPrev"><input type="color" id="textColor"></div>
                        <button class="btn btn-icon" onclick="app.startPicking('txtC')">üîç</button>
                    </div>
                </div>
            </div>
            
            <div class="range-wrap"><input type="range" id="boxOp" min="0" max="100"><output class="range-value"></output></div>

            <div class="control-grid">
                <div class="range-wrap"><input type="range" id="padX" min="0" max="100"><output class="range-value"></output></div>
                <div class="range-wrap"><input type="range" id="padY" min="0" max="100"><output class="range-value"></output></div>
            </div>
            <div class="range-wrap" id="radControl"><input type="range" id="radius" min="0" max="50"><output class="range-value"></output></div>
        </div>

        <div class="panel-section">
            <div class="section-title">Advanced</div>
            <details>
                <summary>Border</summary>
                <div class="det-content">
                    <div style="display:flex; justify-content:space-between;"><label>Active</label> <input type="checkbox" id="hasBorder"></div>
                    <div class="range-wrap"><input type="range" id="bWidth" min="1" max="20"><output class="range-value"></output></div>
                    <select id="bStyle"><option value="solid">Solid</option><option value="dashed">Dashed</option><option value="dotted">Dotted</option></select>
                    <div class="color-row" style="margin-top:8px;">
                        <div class="color-well" id="borderPrev"><input type="color" id="borderColor"></div>
                        <button class="btn btn-icon" onclick="app.startPicking('bColor')">üîç</button>
                    </div>
                </div>
            </details>
            <details>
                <summary>Shadow</summary>
                <div class="det-content">
                    <div style="display:flex; justify-content:space-between;"><label>Active</label> <input type="checkbox" id="hasShadow"></div>
                    <div class="range-wrap"><input type="range" id="sBlur" min="0" max="50"><output class="range-value"></output></div>
                    <div class="control-grid">
                        <div class="range-wrap"><input type="range" id="sX" min="-20" max="20"><output class="range-value"></output></div>
                        <div class="range-wrap"><input type="range" id="sY" min="-20" max="20"><output class="range-value"></output></div>
                    </div>
                    <div class="color-row">
                        <div class="color-well" id="shadowPrev"><input type="color" id="shadowColor"></div>
                        <button class="btn btn-icon" onclick="app.startPicking('sColor')">üîç</button>
                    </div>
                </div>
            </details>
        </div>

        <div class="panel-section">
            <div class="section-title">Position</div>
            <div class="range-wrap"><input type="range" id="size" min="20" max="200"><output class="range-value"></output></div>
            <div class="control-grid">
                <div class="range-wrap"><input type="range" id="mX" min="0" max="100"><output class="range-value"></output></div>
                <div class="range-wrap"><input type="range" id="mY" min="0" max="100"><output class="range-value"></output></div>
            </div>
            <div style="display:flex; gap:4px; margin-top:8px;">
                <button class="btn" style="flex:1" onclick="app.setCorner('TL')">‚Üñ</button>
                <button class="btn" style="flex:1" onclick="app.setCorner('TR')">‚Üó</button>
                <button class="btn" style="flex:1" onclick="app.setCorner('BL')">‚Üô</button>
                <button class="btn" style="flex:1" onclick="app.setCorner('BR')">‚Üò</button>
            </div>
        </div>

        <div style="margin-top:auto; padding:16px; display:flex; flex-direction:column; gap:8px;">
            <button class="btn btn-primary" onclick="app.downloadCurrent()">Download Current</button>
            <button class="btn" onclick="app.downloadAll()">üì¶ Download All (ZIP)</button>
            <button class="btn" style="color:#ef4444;" onclick="app.clear()">Clear All</button>
        </div>
    </aside>
</main>

<script>
function initSliders() {
    document.querySelectorAll('.range-wrap').forEach(wrap => {
        const range = wrap.querySelector('input[type="range"]');
        const bubble = wrap.querySelector('.range-value');
        range.addEventListener('input', () => setBubble(range, bubble));
        range.addEventListener('mousedown', () => { setBubble(range, bubble); bubble.classList.add('show'); });
        range.addEventListener('touchstart', () => { setBubble(range, bubble); bubble.classList.add('show'); });
        range.addEventListener('mouseup', () => bubble.classList.remove('show'));
        range.addEventListener('touchend', () => bubble.classList.remove('show'));
        setBubble(range, bubble);
    });
}
function setBubble(range, bubble) {
    const val = range.value;
    const min = range.min ? range.min : 0;
    const max = range.max ? range.max : 100;
    const newVal = Number(((val - min) * 100) / (max - min));
    bubble.innerHTML = val;
    bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
}

const app = {
    c: document.getElementById('mainCanvas'),
    ctx: null,
    lens: { div: document.getElementById('proLens'), c: document.getElementById('lensCanvas'), ctx: null, code: document.getElementById('lensColorCode') },
    
    queue: [], curr: null, img: null,
    t: { s: 1, x: 0, y: 0 },
    reqId: null,
    
    state: {
        text: 'MP', icon: 'gemini', shape: 'pill',
        size: 50, mX: 5, mY: 5, corner: 'BR',
        boxC: '#6366f1', boxOp: 1, txtC: '#ffffff', txtOp: 1,
        padX: 0.8, padY: 0.2, radius: 12,
        hasBorder: false, bWidth: 2, bStyle: 'solid', bColor: '#ffffff',
        hasShadow: true, sBlur: 15, sX: 0, sY: 5, sColor: '#000000'
    },
    
    picking: false, targetKey: 'boxC',
    icons: {
        gemini: new Path2D("M12 2L14.1 8.5C14.6 10 15.8 11.2 17.2 11.6L22 12.8L17.2 14C15.8 14.4 14.6 15.6 14.1 17L12 23.6L9.9 17C9.4 15.6 8.2 14.4 6.8 14L2 12.8L6.8 11.6C8.2 11.2 9.4 10 9.9 8.5L12 2Z"),
        chatgpt: new Path2D("M17.5 9.8c-.5-2.1-2.1-3.8-4.1-4.3-2.6-.6-5.3.5-6.6 2.8-.4 0-.8.1-1.2.2C3.2 9.1 1.5 11.4 1.5 13.9c0 2.5 1.8 4.8 4.2 5.6 2.1.7 4.4.1 5.8-1.6.5.1.9.2 1.4.2 2.6 0 5.1-1.7 6.1-4.2 1-2.5.2-5.3-1.9-7 0-.4.1-.8.1-1.2 0-.3 0-.6.1-.9zM12 18.5c-3.6 0-6.5-2.9-6.5-6.5S8.4 5.5 12 5.5s6.5 2.9 6.5 6.5-2.9 6.5-6.5 6.5z"),
        copilot: new Path2D("M12 4C7.6 4 4 7.6 4 12s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z"),
        deepseek: new Path2D("M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 15c-2.8 0-5-2.2-5-5s2.2-5 5-5 5 2.2 5 5-2.2 5-5 5z"),
        apple: new Path2D("M17 13.9c-.2 2.5 2.2 3.3 2.3 3.4 0 .1-1.3 4.3-4.1 4.3-1.1 0-2.2-.7-3.5-.7-1.3 0-2.6.7-3.4.7-2.7 0-5.5-4.5-5.5-8.2 0-3.5 2.2-5.6 5.3-5.6 1.2 0 2.5.8 3.2.8.8 0 2.1-.9 3.8-.9 1.4 0 2.9.6 4.1 1.7-3.6 1.6-3 6.3-2.2 4.6zM13.5 4c.6-1.5 2.5-2.2 2.5-2.2-2.1.1-4.2 1.5-4.6 3-.3 1.3 1.2 2.5 2.1 2.3z")
    },

    init() {
        this.ctx = this.c.getContext('2d');
        this.lens.ctx = this.lens.c.getContext('2d');
        this.c.width = 0; this.c.height = 0;
        this.lens.ctx.imageSmoothingEnabled = false;
        document.getElementById('fileInput').onchange = e => this.handleFiles(e.target.files);
        this.loadSettings();
        this.bindEvents();
        this.setupGestures();
        this.setupResizer();
        initSliders();
    },

    bindEvents() {
        const bind = (id, key, format = v => v) => {
            const el = document.getElementById(id);
            if (!el) return;
            if(el.type === 'checkbox') el.checked = this.state[key];
            else if(key.includes('Op') || key.includes('pad')) el.value = Math.round(this.state[key] * 100);
            else el.value = this.state[key];

            el.addEventListener('input', (e) => {
                this.state[key] = el.type === 'checkbox' ? el.checked : format(e.target.value);
                this.requestDraw();
            });
            el.addEventListener('change', () => this.saveSettings());
        };
        bind('badgeText', 'text');
        bind('boxColor', 'boxC'); bind('textColor', 'txtC'); bind('borderColor', 'bColor'); bind('shadowColor', 'sColor');
        bind('size', 'size', parseInt); bind('mX', 'mX', parseInt); bind('mY', 'mY', parseInt);
        bind('boxOp', 'boxOp', v => v/100); bind('textOp', 'txtOp', v => v/100);
        bind('padX', 'padX', v => v/100); bind('padY', 'padY', v => v/100); bind('radius', 'radius', parseInt);
        bind('bWidth', 'bWidth', parseInt); bind('bStyle', 'bStyle');
        bind('sBlur', 'sBlur', parseInt); bind('sX', 'sX', parseInt); bind('sY', 'sY', parseInt);
        bind('hasBorder', 'hasBorder'); bind('hasShadow', 'hasShadow');
    },

    requestDraw() {
        if (!this.reqId) {
            this.reqId = requestAnimationFrame(() => {
                this.draw(); this.updateUI(); this.reqId = null;
            });
        }
    },

    handleFiles(files) {
        if (!files.length) return;
        Array.from(files).forEach(f => this.queue.push({ id: Math.random(), url: URL.createObjectURL(f), name: f.name, done: false }));
        this.renderQ();
        if (!this.curr && this.queue.length) this.load(this.queue[this.queue.length - files.length].id);
        document.getElementById('fileInput').value = '';
    },

    // --- Updated Render Queue with Remove Events ---
    renderQ() {
        const strip = document.getElementById('queueStrip');
        strip.innerHTML = '';
        if (this.queue.length === 0) {
            document.getElementById('emptyState').classList.remove('d-none');
            this.c.style.display = 'none';
        } else {
            document.getElementById('emptyState').classList.add('d-none');
            this.c.style.display = 'block';
            this.queue.forEach(q => {
                const el = document.createElement('div');
                el.className = `q-thumb ${q.id === this.curr ? 'active' : ''} ${q.done ? 'done' : ''}`;
                el.innerHTML = `<img src="${q.url}">`;
                el.onclick = () => this.load(q.id);

                // Right Click (Desktop)
                el.oncontextmenu = (e) => {
                    e.preventDefault();
                    this.removeImage(q.id);
                };

                // Long Press (Mobile)
                let pressTimer;
                const startPress = () => { pressTimer = setTimeout(() => { this.removeImage(q.id); navigator.vibrate(50); }, 600); };
                const cancelPress = () => clearTimeout(pressTimer);
                
                el.addEventListener('touchstart', startPress);
                el.addEventListener('touchend', cancelPress);
                el.addEventListener('touchmove', cancelPress);

                strip.appendChild(el);
            });
        }
    },

    removeImage(id) {
        if(confirm('Remove this image from queue?')) {
            const idx = this.queue.findIndex(i => i.id === id);
            if(idx > -1) {
                // If removing current, try to switch
                if(this.curr === id) {
                    this.queue.splice(idx, 1);
                    this.curr = null;
                    this.img = null;
                    if(this.queue.length > 0) this.load(this.queue[Math.min(idx, this.queue.length - 1)].id);
                } else {
                    this.queue.splice(idx, 1);
                }
                this.renderQ();
                if(this.queue.length === 0) this.draw(); // Clear canvas
            }
        }
    },

    load(id) {
        this.curr = id;
        this.renderQ();
        const item = this.queue.find(i => i.id === id);
        const img = new Image();
        img.onload = () => {
            this.img = img;
            this.c.width = img.width; this.c.height = img.height;
            this.fitView(); // Now works perfectly due to CSS fix
            this.requestDraw();
        };
        img.src = item.url;
    },

    // --- ZOOM & PAN (Fixed Centering) ---
    fitView() {
        const area = document.getElementById('gestureArea');
        const scale = Math.min((area.clientWidth - 40) / this.img.width, (area.clientHeight - 40) / this.img.height);
        this.t.s = scale > 0 ? scale : 0.1;
        
        // Exact Center Math
        this.t.x = (area.clientWidth - (this.img.width * this.t.s)) / 2;
        this.t.y = (area.clientHeight - (this.img.height * this.t.s)) / 2;
        
        this.applyTransform();
    },

    setupGestures() {
        const area = document.getElementById('gestureArea');

        const zoomToPoint = (clientX, clientY, factor) => {
            const rect = area.getBoundingClientRect();
            const mouseX = clientX - rect.left;
            const mouseY = clientY - rect.top;
            const worldX = (mouseX - this.t.x) / this.t.s;
            const worldY = (mouseY - this.t.y) / this.t.s;
            this.t.s *= factor;
            this.t.x = mouseX - worldX * this.t.s;
            this.t.y = mouseY - worldY * this.t.s;
            this.applyTransform();
        };

        area.addEventListener('wheel', e => {
            e.preventDefault();
            zoomToPoint(e.clientX, e.clientY, e.deltaY > 0 ? 0.9 : 1.1);
        }, { passive: false });

        let startX = 0, startY = 0, isDrag = false, initDist = 0;
        const getDist = (ts) => Math.hypot(ts[0].clientX - ts[1].clientX, ts[0].clientY - ts[1].clientY);
        const getCenter = (ts) => ({ x: (ts[0].clientX + ts[1].clientX)/2, y: (ts[0].clientY + ts[1].clientY)/2 });

        const onStart = (e) => {
            if(this.picking) return;
            if(e.touches && e.touches.length === 2) { isDrag = false; initDist = getDist(e.touches); } 
            else { isDrag = true; const p = e.touches ? e.touches[0] : e; startX = p.clientX - this.t.x; startY = p.clientY - this.t.y; }
        };

        const onMove = (e) => {
            if(this.picking) { this.lensUpdate(e); return; }
            if(e.touches && e.touches.length === 2) {
                e.preventDefault();
                const newDist = getDist(e.touches);
                if(initDist > 0) zoomToPoint((e.touches[0].clientX+e.touches[1].clientX)/2, (e.touches[0].clientY+e.touches[1].clientY)/2, newDist / initDist);
                initDist = newDist;
            } else if(isDrag) {
                e.preventDefault();
                const p = e.touches ? e.touches[0] : e;
                this.t.x = p.clientX - startX; this.t.y = p.clientY - startY;
                this.applyTransform();
            }
        };

        const onEnd = () => { if(this.picking) this.pickColor(); isDrag = false; initDist = 0; };

        area.addEventListener('mousedown', onStart);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onEnd);
        area.addEventListener('touchstart', onStart, { passive: false });
        area.addEventListener('touchmove', onMove, { passive: false });
        area.addEventListener('touchend', onEnd);
    },

    applyTransform() {
        document.getElementById('canvasContainer').style.transform = `translate(${this.t.x}px, ${this.t.y}px) scale(${this.t.s})`;
    },

    setupResizer() {
        const handle = document.getElementById('resizer');
        const canvasArea = document.querySelector('.canvas-area');
        const toolsPanel = document.querySelector('.tools-panel');
        const isMobile = () => window.innerWidth <= 900;
        let isResizing = false;

        const start = (e) => { isResizing = true; handle.classList.add('dragging'); document.body.style.cursor = isMobile() ? 'row-resize' : 'col-resize'; };
        const end = () => { isResizing = false; handle.classList.remove('dragging'); document.body.style.cursor = ''; };
        const move = (e) => {
            if(!isResizing) return;
            e.preventDefault();
            const p = e.touches ? e.touches[0] : e;
            if(isMobile()) {
                const h = p.clientY - document.querySelector('header').clientHeight;
                if(h > 100 && h < window.innerHeight - 100) canvasArea.style.height = h + 'px';
            } else {
                const w = window.innerWidth - p.clientX;
                if(w > 200 && w < 600) toolsPanel.style.width = w + 'px';
            }
        };
        handle.addEventListener('mousedown', start);
        window.addEventListener('mouseup', end);
        window.addEventListener('mousemove', move);
        handle.addEventListener('touchstart', start, {passive:false});
        window.addEventListener('touchend', end);
        window.addEventListener('touchmove', move, {passive:false});
    },

    startPicking(key) {
        if(!this.img) return;
        this.picking = true; this.targetKey = key;
        document.querySelector('.canvas-area').classList.add('picking');
        this.lens.div.style.display = 'block';
    },

    lensUpdate(e) {
        const p = e.touches ? e.touches[0] : e;
        const rect = this.c.getBoundingClientRect();
        this.lens.div.style.left = p.clientX + 'px'; this.lens.div.style.top = p.clientY + 'px';
        const scaleX = this.c.width / rect.width;
        const scaleY = this.c.height / rect.height;
        const cx = Math.floor((p.clientX - rect.left) * scaleX);
        const cy = Math.floor((p.clientY - rect.top) * scaleY);
        
        this.lens.ctx.clearRect(0,0,300,300);
        this.lens.ctx.drawImage(this.c, cx - 5, cy - 5, 11, 11, 0, 0, this.lens.c.width, this.lens.c.height);
        
        const pixel = this.ctx.getImageData(cx, cy, 1, 1).data;
        const hex = "#" + ((1<<24)+(pixel[0]<<16)+(pixel[1]<<8)+pixel[2]).toString(16).slice(1).toUpperCase();
        this.lens.code.innerText = hex; this.lens.code.style.background = hex;
        this.lens.code.style.color = (pixel[0]*0.299 + pixel[1]*0.587 + pixel[2]*0.114) > 186 ? '#000' : '#fff';
        this.lastPick = { x: cx, y: cy, hex: hex };
    },

    pickColor() {
        if(!this.picking || !this.lastPick) return;
        this.state[this.targetKey] = this.lastPick.hex;
        this.picking = false;
        document.querySelector('.canvas-area').classList.remove('picking');
        this.lens.div.style.display = 'none';
        this.requestDraw();
        this.saveSettings();
    },

    draw() {
        if (!this.img) return;
        const ctx = this.ctx; const s = this.state;
        ctx.clearRect(0, 0, this.c.width, this.c.height);
        ctx.drawImage(this.img, 0, 0);

        const H = s.size;
        const fs = H * 0.45;
        ctx.font = `bold ${fs}px Inter, sans-serif`;
        const tw = ctx.measureText(s.text).width;
        
        const hasIcon = s.icon !== 'none';
        const iSize = H * 0.5;
        const iGap = hasIcon ? H * 0.25 : 0;
        const iW = hasIcon ? iSize : 0;
        
        const padX = s.shape === 'text' ? 0 : (H * s.padX); 
        const padY = s.shape === 'text' ? 0 : (H * s.padY); 
        
        let bW = tw + iW + iGap + (padX * 2);
        let bH = H + (padY * 2);
        if(s.shape === 'text') bH = fs * 1.2;

        const w = this.c.width; const h = this.c.height;
        const x = s.corner.includes('L') ? w*(s.mX/100) : w - bW - w*(s.mX/100);
        const y = s.corner.includes('T') ? h*(s.mY/100) : h - bH - h*(s.mY/100);

        ctx.save();
        if(s.hasShadow) { ctx.shadowColor = s.sColor; ctx.shadowBlur = s.sBlur; ctx.shadowOffsetX = s.sX; ctx.shadowOffsetY = s.sY; } 
        else { ctx.shadowColor = 'transparent'; }

        ctx.globalAlpha = s.boxOp;
        if(s.shape !== 'text') {
            ctx.fillStyle = s.boxC;
            ctx.beginPath();
            let r = s.shape === 'pill' ? bH/2 : s.radius;
            if(s.shape === 'rect' && r > bH/2) r = bH/2;
            ctx.roundRect(x, y, bW, bH, r);
            ctx.fill();

            if(s.hasBorder) {
                ctx.lineWidth = s.bWidth; ctx.strokeStyle = s.bColor; ctx.shadowColor = 'transparent';
                if(s.bStyle === 'dashed') ctx.setLineDash([bH*0.2, bH*0.1]);
                if(s.bStyle === 'dotted') ctx.setLineDash([bH*0.05, bH*0.05]);
                ctx.stroke(); ctx.setLineDash([]);
            }
        }

        ctx.globalAlpha = s.txtOp;
        ctx.fillStyle = s.txtC;
        if(s.shape==='text' && s.hasShadow) { ctx.shadowColor = s.sColor; ctx.shadowBlur=s.sBlur; ctx.shadowOffsetX=s.sX; ctx.shadowOffsetY=s.sY; }
        else if(s.shape !== 'text') { ctx.shadowColor = 'transparent'; }
        
        let cx = x + padX;
        const cy = y + bH/2;

        if(hasIcon) {
            ctx.save();
            ctx.translate(cx + iSize/2, cy); ctx.scale(iSize/24, iSize/24); ctx.translate(-12, -12);
            ctx.fill(this.icons[s.icon]); ctx.restore();
            cx += iSize + iGap;
        }

        ctx.textBaseline = 'middle';
        ctx.fillText(s.text, cx, cy + fs * 0.05);
        ctx.restore();
    },

    updateUI() {
        document.getElementById('boxPrev').style.background = this.state.boxC;
        document.getElementById('textPrev').style.background = this.state.txtC;
        document.getElementById('borderPrev').style.background = this.state.bColor;
        document.getElementById('shadowPrev').style.background = this.state.sColor;
        document.getElementById('radControl').style.display = this.state.shape === 'rect' ? 'block' : 'none';
        
        document.querySelectorAll('.icon-btn-opt').forEach(b => b.classList.toggle('active', b.getAttribute('onclick').includes(`'${this.state.icon}'`)));
        document.querySelectorAll('.tab').forEach(b => b.classList.toggle('active', b.getAttribute('onclick').includes(`'${this.state.shape}'`)));
    },

    saveSettings() { localStorage.setItem('mp_pro_v5', JSON.stringify(this.state)); },
    loadSettings() {
        const d = localStorage.getItem('mp_pro_v5');
        if(d) Object.assign(this.state, JSON.parse(d));
        document.body.setAttribute('data-theme', localStorage.getItem('mp_theme') || 'dark');
    },

    toggleTheme() {
        const n = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', n);
        localStorage.setItem('mp_theme', n);
    },
    toggleQueue() { document.getElementById('queueStrip').classList.toggle('hidden'); },
    clear() { if(confirm('Clear all?')) { this.queue=[]; this.curr=null; this.img=null; this.renderQ(); } },
    setIcon(i) { this.state.icon = i; this.requestDraw(); },
    setShape(s) { this.state.shape = s; this.requestDraw(); },
    setCorner(c) { this.state.corner = c; this.requestDraw(); },

    downloadCurrent() {
        if(!this.curr) return;
        this.c.toBlob(b => {
            saveAs(b, `MP_${this.queue.find(i => i.id === this.curr).name}`);
            const qItem = this.queue.find(i => i.id === this.curr);
            if(qItem) qItem.done = true;
            this.renderQ();
        });
    },
    async downloadAll() {
        if(!this.queue.length) return;
        const zip = new JSZip();
        const btn = document.querySelector('button[onclick="app.downloadAll()"]');
        const old = btn.innerText; btn.innerText = "Zipping...";
        const ogImg = this.img;
        
        for(const item of this.queue) {
            await new Promise(r => {
                const i = new Image();
                i.onload = () => { 
                    this.img=i; this.c.width=i.width; this.c.height=i.height; this.draw(); 
                    this.c.toBlob(b => { zip.file(`MP_${item.name}`, b); item.done = true; r(); }); 
                };
                i.src = item.url;
            });
        }
        this.img = ogImg; if(this.curr) this.load(this.curr);
        zip.generateAsync({type:"blob"}).then(c => { saveAs(c, "Batch.zip"); btn.innerText = old; });
    }
};

app.init();
</script>
    
<script>
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');
</script>
</body>
</html>
